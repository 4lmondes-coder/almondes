<!DOCTYPE html>
<html lang="pt-BR"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Player Douglas Almondes</title>

<!-- tiny embedded icon (base64 PNG) usado no manifest -->
<link id="pwamanifestlink" rel="manifest" href="blob:null/46f08998-cc30-4584-9a0d-4f467bb86a86">

<style>
:root{
  --bg:#0b0b0b; --panel:#121212; --muted:#bdbdbd; --accent:#1db954; --accent-2:#14a746;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;
  background:linear-gradient(180deg,var(--bg),#070707 70%); color:#fff;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  display:flex; justify-content:center; padding:16px;
}
.app{
  width:100%; max-width:980px; display:grid;
  grid-template-columns: 395px 1fr; gap:14px;
  align-items:start;
  margin-bottom:28px;
}

/* responsive adjustments */
@media (max-width:980px){
  .app{ grid-template-columns: 320px 1fr; gap:12px; padding:12px; }
}
@media (max-width:860px){
  .app{ grid-template-columns: 1fr; padding-bottom:28px }
  .cover{ height:300px }
  .playlist-panel{ height:auto; max-height:395px }
}

/* floating install button */
#installBtn {
  position:fixed; right:14px; bottom:18px; z-index:9999;
  background:var(--accent); color:#021; border:none; padding:10px 14px; border-radius:999px; font-weight:700;
  box-shadow:0 8px 24px rgba(0,0,0,0.45); cursor:pointer;
}

/* player styling (copiado e levemente ajustado) */
.panel {
  background:linear-gradient(180deg,var(--panel),#0f0f0f);
  border-radius:14px; padding:16px; box-shadow:0 8px 30px rgba(0,0,0,0.6);
}
.cover {
  width:100%; border-radius:12px; height:395px; background:#0f0f0f;
  display:flex; align-items:center; justify-content:center; position:relative; overflow:hidden;
}
.cover img{ width:100%; height:100%; object-fit:cover; display:block; }
.visual-canvas{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; flex-wrap:wrap; padding:8px }
.track-info{ padding:12px 6px 0; text-align:center }
.title{ font-size:18px; font-weight:700; margin:6px 0 4px; color:#fff; word-break:break-word; }
.artist{ font-size:13px; color:var(--muted); margin-bottom:8px; }
.progress-row{ display:flex; align-items:center; gap:8px; margin-top:10px }
.time{ font-size:12px; color:var(--muted); width:44px; text-align:center; white-space:nowrap; }
.progress{
  -webkit-appearance:none; appearance:none; height:8px; border-radius:999px;
  background:#222; flex:1; outline:none;
}
.progress::-webkit-slider-thumb{ -webkit-appearance:none; appearance:none; width:14px; height:14px; border-radius:50%; background:var(--accent); box-shadow:0 0 6px rgba(29,185,84,0.25) }
.controls { display:flex; justify-content:center; gap:16px; margin-top:14px; align-items:center; flex-wrap:wrap }
.ctrl-btn{ background:none; border:none; color:var(--accent); font-size:22px; width:56px; height:56px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 8px 20px rgba(0,0,0,0.6) }
.ctrl-btn.secondary{ background:#0f0f0f; color:var(--muted); width:44px; height:44px; font-size:18px; border-radius:12px; }
.ctrl-btn:active{ transform:scale(.96) }

/* sleep timer area */
.sleep {
  display:flex; gap:10px; align-items:center; justify-content:space-between; margin-top:14px; padding-top:12px; border-top:1px solid #111;
  flex-wrap:wrap;
}
.sleep .left{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
.sleep .countdown{ background:#0d0d0d; padding:8px 12px; border-radius:10px; color:var(--muted) }

/* playlist */
.playlist-panel{ background:linear-gradient(180deg,#0f0f0f,#0b0b0b); border-radius:14px; padding:12px; height:calc(100vh - 72px); overflow:hidden; box-shadow:0 8px 30px rgba(0,0,0,0.6) }
.header-list{ display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:10px; flex-wrap:wrap }
.label{ font-weight:700; color:#fff }
.controls-top{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
.btn-small{ background:var(--accent); color:#041; border:none; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:700 }
.choose{ background:#222; color:var(--muted); padding:8px 12px; border-radius:10px; cursor:pointer; border: none; }

/* list and items */
.list{ overflow:auto; height:calc(100% - 64px); padding-right:6px }
.track-item{ padding:10px; border-radius:10px; display:flex; gap:12px; align-items:center; cursor:pointer; background:transparent; transition:all .12s; border:1px solid transparent; }
.track-item:hover{ background:#111 }
.track-item.active{ background:linear-gradient(90deg, rgba(29,185,84,.12), transparent); border-color:rgba(29,185,84,.14) }
.track-meta{ flex:1; min-width:0 }
.track-title{ font-size:14px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.track-sub{ font-size:12px; color:var(--muted) }

/* small list item icon (cover thumbnail) */
.track-thumb{ width:44px; height:44px; border-radius:8px; background:#0b0b0b; flex:0 0 44px; overflow:hidden; display:flex; align-items:center; justify-content:center }
.track-thumb img{ width:100%; height:100%; object-fit:cover; display:block }

/* small devices: shrink panels padding */
@media (max-width:420px){
  .ctrl-btn{ width:46px; height:46px; font-size:18px }
  .cover{ height:240px }
}
</style>
</head>
<body>

<!-- Install button (hidden until prompt available) -->
<button id="installBtn" style="display:none">Instalar</button>

<div class="app" id="appRoot">
 <!-- ESQUERDA: Tocando agora -->
  <div class="panel">
    <div class="cover" id="coverBox">
      <img id="coverImg" src="file:///C:/Users/dougl/AppData/Local/Packages/5319275A.WhatsAppDesktop_cv1g1gvanyjgm/LocalState/sessions/C39AE1F65884ADE59D041492DB9376BFE28D4E65/transfers/2026-08/player%20-%2012-2025.html" alt="Capa" style="display:none">
      <div class="visual-canvas" id="visualCanvas"><div style="width: 2.77778%; height: 6px; margin: 0px 2px; background: linear-gradient(rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.04)); border-radius: 6px; transform-origin: center bottom;"></div><div style="width: 2.77778%; height: 6px; margin: 0px 2px; background: linear-gradient(rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.04)); border-radius: 6px; transform-origin: center bottom;"></div><div style="width: 2.77778%; height: 6px; margin: 0px 2px; background: linear-gradient(rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.04)); border-radius: 6px; transform-origin: center bottom;"></div><div style="width: 2.77778%; height: 6px; margin: 0px 2px; background: linear-gradient(rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.04)); border-radius: 6px; transform-origin: center bottom;"></div><div style="width: 2.77778%; height: 6px; margin: 0px 2px; background: linear-gradient(rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.04)); border-radius: 6px; transform-origin: center bottom;"></div><div style="width: 2.77778%; height: 6px; margin: 0px 2px; background: linear-gradient(rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.04)); border-radius: 6px; transform-origin: center bottom;"></div><div style="width: 2.77778%; height: 6px; margin: 0px 2px; background: linear-gradient(rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.04)); border-radius: 6px; transform-origin: center bottom;"></div><div style="width: 2.77778%; height: 6px; margin: 0px 2px; background: linear-gradient(rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.04)); border-radius: 6px; transform-origin: center bottom;"></div><div style="width: 2.77778%; height: 6px; margin: 0px 2px; background: linear-gradient(rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.04)); border-radius: 6px; transform-origin: center bottom;"></div><div style="width: 2.77778%; height: 6px; margin: 0px 2px; background: linear-gradient(rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.04)); border-radius: 6px; transform-origin: center bottom;"></div><div style="width: 2.77778%; height: 6px; margin: 0px 2px; background: linear-gradient(rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.04)); border-radius: 6px; transform-origin: center bottom;"></div><div style="width: 2.77778%; height: 6px; margin: 0px 2px; background: linear-gradient(rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.04)); border-radius: 6px; transform-origin: center bottom;"></div><div style="width: 2.77778%; height: 6px; margin: 0px 2px; background: linear-gradient(rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.04)); border-radius: 6px; transform-origin: center bottom;"></div><div style="width: 2.77778%; height: 6px; margin: 0px 2px; background: linear-gradient(rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.04)); border-radius: 6px; transform-origin: center bottom;"></div><div style="width: 2.77778%; height: 6px; margin: 0px 2px; background: linear-gradient(rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.04)); border-radius: 6px; transform-origin: center bottom;"></div><div style="width: 2.77778%; height: 6px; margin: 0px 2px; background: linear-gradient(rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.04)); border-radius: 6px; transform-origin: center bottom;"></div><div style="width: 2.77778%; height: 6px; margin: 0px 2px; background: linear-gradient(rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.04)); border-radius: 6px; transform-origin: center bottom;"></div><div style="width: 2.77778%; height: 6px; margin: 0px 2px; background: linear-gradient(rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.04)); border-radius: 6px; transform-origin: center bottom;"></div><div style="width: 2.77778%; height: 6px; margin: 0px 2px; background: linear-gradient(rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.04)); border-radius: 6px; transform-origin: center bottom;"></div><div style="width: 2.77778%; height: 6px; margin: 0px 2px; background: linear-gradient(rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.04)); border-radius: 6px; transform-origin: center bottom;"></div><div style="width: 2.77778%; height: 6px; margin: 0px 2px; background: linear-gradient(rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.04)); border-radius: 6px; transform-origin: center bottom;"></div><div style="width: 2.77778%; height: 6px; margin: 0px 2px; background: linear-gradient(rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.04)); border-radius: 6px; transform-origin: center bottom;"></div><div style="width: 2.77778%; height: 6px; margin: 0px 2px; background: linear-gradient(rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.04)); border-radius: 6px; transform-origin: center bottom;"></div><div style="width: 2.77778%; height: 6px; margin: 0px 2px; background: linear-gradient(rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.04)); border-radius: 6px; transform-origin: center bottom;"></div><div style="width: 2.77778%; height: 6px; margin: 0px 2px; background: linear-gradient(rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.04)); border-radius: 6px; transform-origin: center bottom;"></div><div style="width: 2.77778%; height: 6px; margin: 0px 2px; background: linear-gradient(rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.04)); border-radius: 6px; transform-origin: center bottom;"></div><div style="width: 2.77778%; height: 6px; margin: 0px 2px; background: linear-gradient(rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.04)); border-radius: 6px; transform-origin: center bottom;"></div><div style="width: 2.77778%; height: 6px; margin: 0px 2px; background: linear-gradient(rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.04)); border-radius: 6px; transform-origin: center bottom;"></div><div style="width: 2.77778%; height: 6px; margin: 0px 2px; background: linear-gradient(rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.04)); border-radius: 6px; transform-origin: center bottom;"></div><div style="width: 2.77778%; height: 6px; margin: 0px 2px; background: linear-gradient(rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.04)); border-radius: 6px; transform-origin: center bottom;"></div><div style="width: 2.77778%; height: 6px; margin: 0px 2px; background: linear-gradient(rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.04)); border-radius: 6px; transform-origin: center bottom;"></div><div style="width: 2.77778%; height: 6px; margin: 0px 2px; background: linear-gradient(rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.04)); border-radius: 6px; transform-origin: center bottom;"></div><div style="width: 2.77778%; height: 6px; margin: 0px 2px; background: linear-gradient(rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.04)); border-radius: 6px; transform-origin: center bottom;"></div><div style="width: 2.77778%; height: 6px; margin: 0px 2px; background: linear-gradient(rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.04)); border-radius: 6px; transform-origin: center bottom;"></div><div style="width: 2.77778%; height: 6px; margin: 0px 2px; background: linear-gradient(rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.04)); border-radius: 6px; transform-origin: center bottom;"></div><div style="width: 2.77778%; height: 6px; margin: 0px 2px; background: linear-gradient(rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.04)); border-radius: 6px; transform-origin: center bottom;"></div></div>
    </div>

    <div class="track-info">
      <div class="title" id="nowTitle">Nenhuma faixa</div>
      <div class="artist" id="nowArtist">Selecione a pasta de m√∫sicas</div>

      <div class="progress-row">
        <div class="time" id="curTime">0:00</div>
        <input id="progress" class="progress" type="range" min="0" max="100" value="0">
        <div class="time" id="durTime">0:00</div>
      </div>

      <div class="controls">
        <button class="ctrl-btn secondary" id="shuffleBtn" title="Shuffle">üîÄ</button>
        <button class="ctrl-btn" id="prevBtn" title="Anterior">‚èÆÔ∏è</button>
        <button class="ctrl-btn" id="playBtn" title="Play/Pause">‚ñ∂Ô∏è</button>
        <button class="ctrl-btn" id="nextBtn" title="Pr√≥xima">‚è≠Ô∏è</button>
        <button class="ctrl-btn secondary" id="repeatBtn" title="Repeat">üîÅ</button>
      </div>

      <div class="volume-control" style="margin-top:8px; justify-content:center;">
        üîä
        <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="1" style="width:140px;margin-left:8px">
      </div>

      <div class="sleep">
        <div class="left">
          <label style="color:var(--muted);font-size:13px">Sleep timer</label>
          <input id="sleepMin" type="number" min="1" max="240" placeholder="min 10" style="width:70px;padding:8px;border-radius:10px;border:none;background:#0c0c0c;color:#fff">
          <button id="setSleep" class="btn-small">Ativar</button>
          <button id="cancelSleep" class="choose" disabled="">Cancelar</button>
        </div>
        <div class="countdown" id="countdownDisplay">‚Äî</div>
      </div>
    </div>
  </div>

  <!-- DIREITA: Lista de reprodu√ß√£o -->
  <div class="playlist-panel panel" id="playlistPanel">
    <div class="header-list">
      <div><div class="label">Playlist local Douglas Almondes</div><div style="font-size:12px;color:var(--muted)">Selecione a pasta contendo MP3</div></div>
      <div class="controls-top">
        <label for="fileInput" class="choose" title="Selecionar pasta">üìÅ Selecionar</label>
        <input id="fileInput" type="file" webkitdirectory="" multiple="" accept="audio/*" style="display:none">
        <button id="clearBtn" class="choose" title="Limpar lista">Limpar</button>
      </div>
    </div>

    <div style="margin-bottom:8px;display:flex;gap:8px;align-items:center">
      <div style="font-size:13px;color:var(--muted)">√öltima posi√ß√£o:</div>
      <div style="font-size:13px;color:var(--muted)" id="lastSaved">‚Äî</div>
      <button id="savePos" class="choose" style="margin-left:auto">Salvar agora</button>
    </div>

    <div class="list" id="list"></div>
  </div>
</div>

<!-- elemento de √°udio oculto -->
<audio id="audio" crossorigin="anonymous"></audio>

<!-- load jsmediatags (CDN). Service worker caches it on first run -->
<script src="./Player Douglas Almondes_files/jsmediatags.min.js.transferir"></script>

<script>
/* ----------------- PWA: manifest blob & install prompt  ----------------- */
(function createManifest(){
  const manifest = {
    name: "Player Douglas Almondes",
    short_name: "Player",
    start_url: ".",
    display: "standalone",
    background_color: "#0b0b0b",
    theme_color: "#1db954",
    icons: [
      // 64x64 embedded PNG (simple green circle icon). Replace with your own if desired.
      { src: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABQElEQVRYR+2WsQ3CMAxF31EAwR4gB6AASD1gACoQIQEkAEWmBPY+Qi64c1msqvJ7V/4VQb6daCefL5fBrGc3CjE9tSAv3DPL7KYhQiMFTBRpAjPUvQ7kRcsx7fkaGBtxoGmsm8HxjR1XYEbglkGuoMQPC9I5hKrrr8oMJEXiZ4FwJ6N5zHCrpygrY2YibHK8JHGIUtK0AE2PIYoDpnM48G+kbiBp5Jj0No4AuwpTn8JqYBzOSbEQhlDLOvHV9m5Q1StCqwoDJZ8CFog0VRklf1nG7SopGKuXyDJpWJWvMR5S6e4ljUyGItLLkoD+1vMYemwqgGhsFqNcmZth8zAIt5x/3Z+0SwAAAABJRU5ErkJggg==", sizes: "64x64", type: "image/png" }
    ]
  };
  const json = JSON.stringify(manifest);
  const blob = new Blob([json], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const link = document.getElementById('pwamanifestlink');
  link.href = url;
})();

/* ----------------- service worker inline via Blob ----------------- */
if ('serviceWorker' in navigator) {
  const swSource = `
  const CACHE_NAME = 'player-douglas-cache-v1';
  const PRECACHE = [
    './',
    'https://cdn.jsdelivr.net/npm/jsmediatags@3.9.7/dist/jsmediatags.min.js'
  ];
  self.addEventListener('install', event => {
    event.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(PRECACHE)).then(()=>self.skipWaiting()));
  });
  self.addEventListener('activate', event => {
    event.waitUntil(self.clients.claim());
  });
  self.addEventListener('fetch', event => {
    // Don't try to handle chrome-extension:// or data: or blob:
    if (event.request.url.startsWith('chrome-extension:') || event.request.url.startsWith('data:') || event.request.url.startsWith('blob:')) return;
    event.respondWith(
      caches.match(event.request).then(resp => {
        if (resp) return resp;
        return fetch(event.request).then(fetchResp => {
          // cache opaque responses (like CDN) cautiously
          if (fetchResp && fetchResp.ok) {
            const copy = fetchResp.clone();
            caches.open(CACHE_NAME).then(c => c.put(event.request, copy));
          }
          return fetchResp;
        }).catch(()=>caches.match('./'));
      })
    );
  });
  `;
  const blob = new Blob([swSource], {type: 'text/javascript'});
  const swUrl = URL.createObjectURL(blob);
  navigator.serviceWorker.register(swUrl).catch(console.warn);
}

/* --------------- PWA install prompt handling ---------------- */
let deferredPrompt = null;
const installBtn = document.getElementById('installBtn');
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn.style.display = 'inline-block';
});
installBtn.addEventListener('click', async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  const choice = await deferredPrompt.userChoice;
  deferredPrompt = null;
  installBtn.style.display = 'none';
});

/* ----------------- Player JS (baseado no seu c√≥digo, completo) ----------------- */
const fileInput = document.getElementById('fileInput');
const listEl = document.getElementById('list');
const audio = document.getElementById('audio');
const playBtn = document.getElementById('playBtn');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const shuffleBtn = document.getElementById('shuffleBtn');
const repeatBtn = document.getElementById('repeatBtn');
const progress = document.getElementById('progress');
const curTime = document.getElementById('curTime');
const durTime = document.getElementById('durTime');
const nowTitle = document.getElementById('nowTitle');
const nowArtist = document.getElementById('nowArtist');
const coverImg = document.getElementById('coverImg');
const coverBox = document.getElementById('coverBox');
const visualCanvas = document.getElementById('visualCanvas');
const sleepMin = document.getElementById('sleepMin');
const setSleep = document.getElementById('setSleep');
const cancelSleep = document.getElementById('cancelSleep');
const countdownDisplay = document.getElementById('countdownDisplay');
const clearBtn = document.getElementById('clearBtn');
const savePosBtn = document.getElementById('savePos');
const lastSaved = document.getElementById('lastSaved');
const volumeSlider = document.getElementById('volumeSlider');

let files = [];            // File objects chosen
let order = [];            // order indices (for shuffle)
let current = 0;           // current index inside 'order' map
let isPlaying = false;
let isShuffle = false;
let isRepeat = false;
let analyser, audioCtx, dataArray, source;
let bars = [];            // visual bars
let sleepTimeout = null, countdownInterval = null, sleepRemaining = 0;

/* helper fmt */
function fmt(s){
  if (s === undefined || s === null || isNaN(s)) return '0:00';
  const m = Math.floor(s/60), sec = Math.floor(s%60).toString().padStart(2,'0');
  return `${m}:${sec}`;
}

/* build visual bars */
function buildVisualizer(cols=36){
  visualCanvas.innerHTML = '';
  bars = [];
  for (let i=0;i<cols;i++){
    const d = document.createElement('div');
    d.style.width = `${100/cols}%`;
    d.style.height = '6px';
    d.style.margin = '0 2px';
    d.style.background = 'linear-gradient(180deg, rgba(255,255,255,0.16), rgba(255,255,255,0.04))';
    d.style.borderRadius = '6px';
    d.style.transformOrigin = 'bottom';
    bars.push(d);
    visualCanvas.appendChild(d);
  }
}
buildVisualizer(36);

/* File selection */
fileInput.addEventListener('change', (e)=>{
  files = Array.from(e.target.files).filter(f => f.name.toLowerCase().endsWith('.mp3') || f.type.startsWith('audio/'));
  if (!files.length) { alert('Nenhum MP3 encontrado.'); return; }
  files.sort((a,b)=> a.name.localeCompare(b.name,'pt-BR', {sensitivity:'base'}));
  order = files.map((_,i)=>i);
  current = 0;
  renderList();
  loadTrackAt(current);
});

/* Clear playlist */
clearBtn.addEventListener('click', ()=>{
  files = []; order = []; current = 0; listEl.innerHTML=''; nowTitle.textContent='Nenhuma faixa'; nowArtist.textContent=''; coverImg.style.display='none';
  localStorage.removeItem('player_files');
});

/* Render list with thumbnail placeholders */
function renderList(){
  listEl.innerHTML = '';
  files.forEach((f,i)=>{
    const wrap = document.createElement('div');
    wrap.className = 'track-item';
    wrap.dataset.index = i;

    const thumb = document.createElement('div');
    thumb.className = 'track-thumb';
    // small placeholder; will try to extract cover on load
    const img = document.createElement('img');
    img.alt = 'thumb';
    img.style.display = 'none';
    thumb.appendChild(img);

    const meta = document.createElement('div'); meta.className='track-meta';
    const t = document.createElement('div'); t.className='track-title'; t.textContent = f.name.replace(/\.[^/.]+$/,'');
    const s = document.createElement('div'); s.className='track-sub'; s.textContent = f.size ? `${(f.size/1024/1024).toFixed(2)} MB` : '';
    meta.appendChild(t); meta.appendChild(s);
    wrap.appendChild(thumb);
    wrap.appendChild(meta);

    wrap.onclick = ()=> {
      const idx = order.indexOf(parseInt(wrap.dataset.index));
      if (idx >= 0) current = idx; else current = 0;
      loadTrackAt(current); play();
    };
    listEl.appendChild(wrap);
  });
  updateActiveInList();
}

/* update active */
function updateActiveInList(){
  document.querySelectorAll('.track-item').forEach(node=>{
    const idx = parseInt(node.dataset.index);
    const pos = order.indexOf(idx);
    node.classList.toggle('active', pos === current);
  });
}

/* load track */
function loadTrackAt(pos){
  if (!files.length) return;
  pos = (pos + order.length) % order.length;
  current = pos;
  const file = files[ order[current] ];
  const url = URL.createObjectURL(file);
  // revoke previous blob if any
  try { if (audio.src && audio.src.startsWith('blob:')) URL.revokeObjectURL(audio.src); } catch(e){}
  audio.src = url;
  nowTitle.textContent = file.name.replace(/\.[^/.]+$/,'');
  nowArtist.textContent = 'Arquivo local';
  coverImg.style.display = 'none';
  visualCanvas.style.opacity = 1;
  // try read ID3 cover (jsmediatags)
  try {
    if (window.jsmediatags) {
      jsmediatags.read(file, {
        onSuccess: function(tag) {
          const picture = tag.tags.picture;
          const t = tag.tags.title || file.name.replace(/\.[^/.]+$/,'');
          const artist = tag.tags.artist || 'Local';
          nowTitle.textContent = t; nowArtist.textContent = artist;
          if (picture && picture.data) {
            const base64String = arrayBufferToBase64(picture.data);
            coverImg.src = `data:${picture.format};base64,${base64String}`;
            coverImg.style.display = 'block';
            visualCanvas.style.opacity = 0.14;
            // also set thumbnail in list (if present)
            const items = listEl.querySelectorAll('.track-item');
            items.forEach(node=>{
              if (parseInt(node.dataset.index) === order[current]){
                const thumbImg = node.querySelector('.track-thumb img');
                thumbImg.src = coverImg.src;
                thumbImg.style.display = 'block';
              }
            });
          } else {
            coverImg.style.display = 'none';
            visualCanvas.style.opacity = 1;
          }
        },
        onError: function() {
          coverImg.style.display = 'none';
          visualCanvas.style.opacity = 1;
        }
      });
    } else {
      coverImg.style.display = 'none';
      visualCanvas.style.opacity = 1;
    }
  } catch(e){
    coverImg.style.display = 'none';
    visualCanvas.style.opacity = 1;
  }
  updateActiveInList();
  audio.load();
}

/* convert picture data */
function arrayBufferToBase64(buffer){
  let binary = '';
  const bytes = new Uint8Array(buffer);
  const len = bytes.byteLength;
  for (let i=0;i<len;i++){ binary += String.fromCharCode(bytes[i]); }
  return btoa(binary);
}

/* playback controls */
function play(){
  if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{});
  audio.play().then(()=>{ isPlaying=true; playBtn.textContent='‚è∏Ô∏è'; startVisualizer(); }).catch(()=>{});
}
function pause(){
  audio.pause(); isPlaying=false; playBtn.textContent='‚ñ∂Ô∏è';
}
playBtn.addEventListener('click', ()=> audio.paused ? play() : pause());
prevBtn.addEventListener('click', ()=> {
  if (audio.currentTime > 2) { audio.currentTime = 0; } else {
    current = (current - 1 + order.length) % order.length;
    loadTrackAt(current); play();
  }
});
nextBtn.addEventListener('click', ()=> {
  if (isRepeat) { loadTrackAt(current); play(); return; }
  current = (current + 1) % order.length;
  loadTrackAt(current); play();
});
shuffleBtn.addEventListener('click', ()=>{
  isShuffle = !isShuffle;
  shuffleBtn.style.background = isShuffle ? 'rgba(29,185,84,0.14)' : 'transparent';
  if (isShuffle){
    order = files.map((_,i)=>i).sort(()=>Math.random()-0.5);
  } else {
    order = files.map((_,i)=>i);
  }
  renderList(); updateActiveInList();
});
repeatBtn.addEventListener('click', ()=>{
  isRepeat = !isRepeat;
  repeatBtn.style.background = isRepeat ? 'rgba(29,185,84,0.14)' : 'transparent';
});

/* when audio ends */
audio.addEventListener('ended', ()=>{
  if (isRepeat) { loadTrackAt(current); play(); return; }
  current = (current + 1) % order.length;
  loadTrackAt(current); play();
});

/* progress updates */
audio.addEventListener('timeupdate', ()=>{
  if (!isNaN(audio.duration) && audio.duration>0){
    const pct = (audio.currentTime / audio.duration) * 100;
    progress.value = pct;
    curTime.textContent = fmt(audio.currentTime);
    durTime.textContent = fmt(audio.duration);
  } else {
    curTime.textContent = fmt(audio.currentTime);
    durTime.textContent = '0:00';
  }
});
progress.addEventListener('input', ()=> {
  if (!isNaN(audio.duration) && audio.duration>0) audio.currentTime = (progress.value/100) * audio.duration;
});

/* visualizer */
function startVisualizer(){
  if (!audioCtx){
    try {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      source = audioCtx.createMediaElementSource(audio);
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 128;
      dataArray = new Uint8Array(analyser.frequencyBinCount);
      source.connect(analyser);
      analyser.connect(audioCtx.destination);
    } catch(e){
      return;
    }
  }
  renderViz();
}
let vizId = null;
function renderViz(){
  if (!analyser) return;
  analyser.getByteFrequencyData(dataArray);
  for (let i=0;i<bars.length;i++){
    const v = dataArray[i] || 0;
    const h = Math.max(6, (v/255) * 160);
    bars[i].style.height = h + 'px';
    bars[i].style.background = `linear-gradient(180deg, rgba(29,185,84,${0.9}), rgba(29,185,84,${0.2}))`;
  }
  vizId = requestAnimationFrame(renderViz);
}

/* Sleep timer logic (bloqueia campo durante contagem) */
setSleep.addEventListener('click', () => {
  const m = parseInt(sleepMin.value);
  if (!m || m <= 0) return alert('Informe minutos v√°lidos');

  setSleep.disabled = true;
  cancelSleep.disabled = false;
  sleepMin.disabled = true;
  setSleep.textContent = '‚è≥';

  clearTimeout(sleepTimeout);
  clearInterval(countdownInterval);

  sleepRemaining = m * 60;
  countdownDisplay.textContent = formatCountdown(sleepRemaining);
  countdownDisplay.style.color = '#ffecb3';

  countdownInterval = setInterval(() => {
    sleepRemaining--;
    countdownDisplay.textContent = formatCountdown(sleepRemaining);

    if (sleepRemaining <= 5 && audio.volume > 0) {
      audio.volume = Math.max(0, audio.volume - 0.2);
    }

    if (sleepRemaining <= 0) {
      clearInterval(countdownInterval);
      clearTimeout(sleepTimeout);
      audio.pause();
      countdownDisplay.textContent = 'üò¥ Dormiu';
      countdownDisplay.style.color = '#b3b3b3';
      resetSleepControls();
    }
  }, 1000);

  sleepTimeout = setTimeout(() => {
    clearInterval(countdownInterval);
    audio.pause();
    countdownDisplay.textContent = 'üò¥ Dormiu';
    countdownDisplay.style.color = '#b3b3b3';
    resetSleepControls();
  }, m * 60000);
});

cancelSleep.addEventListener('click', () => {
  clearTimeout(sleepTimeout);
  clearInterval(countdownInterval);
  countdownDisplay.textContent = '‚Äî';
  countdownDisplay.style.color = '#bdbdbd';
  sleepMin.value = '';
  resetSleepControls();
});

function resetSleepControls() {
  setSleep.disabled = false;
  cancelSleep.disabled = true;
  sleepMin.disabled = false;
  setSleep.textContent = 'Ativar';
  audio.volume = volumeSlider.value;
}

/* format countdown */
function formatCountdown(sec){
  if (sec<=0) return '0:00';
  const m = Math.floor(sec/60); const s = (sec%60).toString().padStart(2,'0');
  return `${m}:${s}`;
}

/* persist last position */
savePosBtn.addEventListener('click', ()=>{
  try {
    const pos = { idxOrder: order[current] ?? 0, time: audio.currentTime || 0, name: files[order[current]]?.name || '' };
    localStorage.setItem('player_last', JSON.stringify(pos));
    lastSaved.textContent = `${pos.name || '‚Äî'} @ ${fmt(pos.time)}`;
    alert('Posi√ß√£o salva localmente.');
  } catch(e){ console.error(e); alert('Erro ao salvar'); }
});
(function tryRestore(){
  const raw = localStorage.getItem('player_last');
  if (!raw) return lastSaved.textContent='‚Äî';
  try {
    const p = JSON.parse(raw);
    lastSaved.textContent = `${p.name || '‚Äî'} @ ${fmt(p.time || 0)}`;
  } catch(e){ lastSaved.textContent='‚Äî'; }
})();

/* keyboard shortcuts */
document.addEventListener('keydown',(e)=>{
  if (e.code === 'Space') { e.preventDefault(); audio.paused ? play() : pause(); }
  if (e.code === 'ArrowRight') nextBtn.click();
  if (e.code === 'ArrowLeft') prevBtn.click();
});

/* volume control */
volumeSlider.addEventListener('input', () => {
  audio.volume = volumeSlider.value;
});

/* revoke blobs on unload */
window.addEventListener('unload', ()=>{
  try { if (audio.src && audio.src.startsWith('blob:')) URL.revokeObjectURL(audio.src); } catch(e){}
  if (vizId) cancelAnimationFrame(vizId);
});

/* Accessibility: ensure cancelSleep initially disabled */
cancelSleep.disabled = true;

/* Improve UX: when selecting files, also try to show thumbnails in list (deferred) */
function tryPopulateThumbnails(){
  // attempt to read small cover from each file for the list (non-blocking)
  if (!window.jsmediatags) return;
  files.forEach((file, idx) => {
    jsmediatags.read(file, {
      onSuccess: function(tag) {
        const picture = tag.tags.picture;
        if (picture && picture.data){
          const base64String = arrayBufferToBase64(picture.data);
          const dataUrl = `data:${picture.format};base64,${base64String}`;
          const node = listEl.querySelector('.track-item[data-index="'+idx+'"]');
          if (node){
            const img = node.querySelector('.track-thumb img');
            img.src = dataUrl;
            img.style.display = 'block';
          }
        }
      },
      onError: function(){ /* ignore */ }
    });
  });
}

/* After renderList and loadTrackAt, call tryPopulateThumbnails */
const originalRenderList = renderList;
renderList = function(){ originalRenderList(); setTimeout(tryPopulateThumbnails, 300); };

/* Expose small helper to programmatically open file chooser when clicking label */
document.querySelector('label[for="fileInput"]').addEventListener('click', ()=> fileInput.click());

</script>

<script>
/* === AUTO-SELECT PASTA + AUTO-PLAY (UMA √öNICA VEZ) === */
let pastaSelecionadaUmaVez = false;

// abre o seletor automaticamente ao carregar
window.addEventListener('load', () => {
  if (pastaSelecionadaUmaVez) return;

  setTimeout(() => {
    fileInput.click();
  }, 600);
});

// ap√≥s selecionar a pasta, toca automaticamente
fileInput.addEventListener('change', () => {
  if (!files || files.length === 0) return;

  pastaSelecionadaUmaVez = true;

  // garante primeira faixa
  current = 0;
  loadTrackAt(0);

  // pequeno delay para evitar bloqueio de autoplay
  setTimeout(() => {
    play();
  }, 300);

}, { once: true });
</script>


</body></html>

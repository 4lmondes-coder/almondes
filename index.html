<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Player Douglas Almondes</title>

  <!-- Link para o manifest PWA -->
  <link rel="manifest" href="manifest.json">

  <!-- Registro do Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
      .then(() => console.log('Service Worker registrado.'))
      .catch(err => console.error('Falha ao registrar SW:', err));
    }
  </script>

  <style>
:root{
  --bg:#0b0b0b; --panel:#121212; --muted:#bdbdbd; --accent:#1db954; --accent-2:#14a746;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;
  background:linear-gradient(180deg,var(--bg),#070707 70%); color:#fff;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  display:flex; justify-content:center; padding:16px;
}
.app{
  width:100%; max-width:980px; display:grid;
  grid-template-columns: 395px 1fr; gap:14px;
  align-items:start;
  margin-bottom:28px;
}
@media (max-width:980px){
  .app{ grid-template-columns: 320px 1fr; gap:12px; padding:12px; }
}
@media (max-width:860px){
  .app{ grid-template-columns: 1fr; padding-bottom:28px }
  .cover{ height:300px }
  .playlist-panel{ height:auto; max-height:395px }
}
#installBtn {
  position:fixed; right:14px; bottom:18px; z-index:9999;
  background:var(--accent); color:#021; border:none; padding:10px 14px; border-radius:999px; font-weight:700;
  box-shadow:0 8px 24px rgba(0,0,0,0.45); cursor:pointer;
}
.panel {
  background:linear-gradient(180deg,var(--panel),#0f0f0f);
  border-radius:14px; padding:16px; box-shadow:0 8px 30px rgba(0,0,0,0.6);
}
.cover {
  width:100%; border-radius:12px; height:395px; background:#0f0f0f;
  display:flex; align-items:center; justify-content:center; position:relative; overflow:hidden;
}
.cover img{ width:100%; height:100%; object-fit:cover; display:block; }
.visual-canvas{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; flex-wrap:wrap; padding:8px }
.track-info{ padding:12px 6px 0; text-align:center }
.title{ font-size:18px; font-weight:700; margin:6px 0 4px; color:#fff; word-break:break-word; }
.artist{ font-size:13px; color:var(--muted); margin-bottom:8px; }
.progress-row{ display:flex; align-items:center; gap:8px; margin-top:10px }
.time{ font-size:12px; color:var(--muted); width:44px; text-align:center; white-space:nowrap; }
.progress{
  -webkit-appearance:none; appearance:none; height:8px; border-radius:999px;
  background:#222; flex:1; outline:none;
}
.progress::-webkit-slider-thumb{ -webkit-appearance:none; appearance:none; width:14px; height:14px; border-radius:50%; background:var(--accent); box-shadow:0 0 6px rgba(29,185,84,0.25) }
.controls { display:flex; justify-content:center; gap:16px; margin-top:14px; align-items:center; flex-wrap:wrap }
.ctrl-btn{ background:none; border:none; color:var(--accent); font-size:22px; width:56px; height:56px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 8px 20px rgba(0,0,0,0.6) }
.ctrl-btn.secondary{ background:#0f0f0f; color:var(--muted); width:44px; height:44px; font-size:18px; border-radius:12px; }
.ctrl-btn:active{ transform:scale(.96) }
.sleep {
  display:flex; gap:10px; align-items:center; justify-content:space-between; margin-top:14px; padding-top:12px; border-top:1px solid #111;
  flex-wrap:wrap;
}
.sleep .left{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
.sleep .countdown{ background:#0d0d0d; padding:8px 12px; border-radius:10px; color:var(--muted) }
.playlist-panel{ background:linear-gradient(180deg,#0f0f0f,#0b0b0b); border-radius:14px; padding:12px; height:calc(100vh - 72px); overflow:hidden; box-shadow:0 8px 30px rgba(0,0,0,0.6) }
.header-list{ display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:10px; flex-wrap:wrap }
.label{ font-weight:700; color:#fff }
.controls-top{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
.btn-small{ background:var(--accent); color:#041; border:none; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:700 }
.choose{ background:#222; color:var(--muted); padding:8px 12px; border-radius:10px; cursor:pointer; border: none; }
.list{ overflow:auto; height:calc(100% - 64px); padding-right:6px }
.track-item{ padding:10px; border-radius:10px; display:flex; gap:12px; align-items:center; cursor:pointer; background:transparent; transition:all .12s; border:1px solid transparent; }
.track-item:hover{ background:#111 }
.track-item.active{ background:linear-gradient(90deg, rgba(29,185,84,.12), transparent); border-color:rgba(29,185,84,.14) }
.track-meta{ flex:1; min-width:0 }
.track-title{ font-size:14px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.track-sub{ font-size:12px; color:var(--muted) }
.track-thumb{ width:44px; height:44px; border-radius:8px; background:#0b0b0b; flex:0 0 44px; overflow:hidden; display:flex; align-items:center; justify-content:center }
.track-thumb img{ width:100%; height:100%; object-fit:cover; display:block }
@media (max-width:420px){
  .ctrl-btn{ width:46px; height:46px; font-size:18px }
  .cover{ height:240px }
}
</style>
</head>
<body>

<button id="installBtn" style="display:none">Instalar</button>

<div class="app" id="appRoot">
  <div class="panel">
    <div class="cover" id="coverBox">
      <img id="coverImg" src="" alt="Capa" style="display:none">
      <div class="visual-canvas" id="visualCanvas"></div>
    </div>
    <div class="track-info">
      <div class="title" id="nowTitle">Nenhuma faixa</div>
      <div class="artist" id="nowArtist">Selecione a pasta de m√∫sicas</div>
      <div class="progress-row">
        <div class="time" id="curTime">0:00</div>
        <input id="progress" class="progress" type="range" min="0" max="100" value="0">
        <div class="time" id="durTime">0:00</div>
      </div>
      <div class="controls">
        <button class="ctrl-btn secondary" id="shuffleBtn" title="Shuffle">üîÄ</button>
        <button class="ctrl-btn" id="prevBtn" title="Anterior">‚èÆÔ∏è</button>
        <button class="ctrl-btn" id="playBtn" title="Play/Pause">‚ñ∂Ô∏è</button>
        <button class="ctrl-btn" id="nextBtn" title="Pr√≥xima">‚è≠Ô∏è</button>
        <button class="ctrl-btn secondary" id="repeatBtn" title="Repeat">üîÅ</button>
      </div>
      <div class="volume-control" style="margin-top:8px; justify-content:center;">
        üîä
        <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="1" style="width:140px;margin-left:8px">
      </div>
      <div class="sleep">
        <div class="left">
          <label style="color:var(--muted);font-size:13px">Sleep timer</label>
          <input id="sleepMin" type="number" min="1" max="240" placeholder="min 10" style="width:70px;padding:8px;border-radius:10px;border:none;background:#0c0c0c;color:#fff">
          <button id="setSleep" class="btn-small">Ativar</button>
          <button id="cancelSleep" class="choose">Cancelar</button>
        </div>
        <div class="countdown" id="countdownDisplay">‚Äî</div>
      </div>
    </div>
  </div>

  <div class="playlist-panel panel" id="playlistPanel">
    <div class="header-list">
      <div><div class="label">Playlist local Douglas Almondes</div><div style="font-size:12px;color:var(--muted)">Selecione a pasta contendo MP3</div></div>
      <div class="controls-top">
        <label for="fileInput" class="choose" title="Selecionar pasta">üìÅ Selecionar</label>
        <input id="fileInput" type="file" webkitdirectory multiple accept="audio/*" style="display:none">
        <button id="clearBtn" class="choose" title="Limpar lista">Limpar</button>
      </div>
    </div>

    <div style="margin-bottom:8px;display:flex;gap:8px;align-items:center">
      <div style="font-size:13px;color:var(--muted)">√öltima posi√ß√£o:</div>
      <div style="font-size:13px;color:var(--muted)" id="lastSaved">‚Äî</div>
      <button id="savePos" class="choose" style="margin-left:auto">Salvar agora</button>
    </div>

    <div class="list" id="list"></div>
  </div>
</div>

<audio id="audio" crossorigin="anonymous"></audio>

<script src="https://cdn.jsdelivr.net/npm/jsmediatags@3.9.7/dist/jsmediatags.min.js"></script>

<script>
// ----------------------------
// PLAYER JS COMPLETO COM SAFE PLAY
// ----------------------------

// Elementos
const fileInput = document.getElementById('fileInput');
const listEl = document.getElementById('list');
const audio = document.getElementById('audio');
const playBtn = document.getElementById('playBtn');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const shuffleBtn = document.getElementById('shuffleBtn');
const repeatBtn = document.getElementById('repeatBtn');
const progress = document.getElementById('progress');
const curTime = document.getElementById('curTime');
const durTime = document.getElementById('durTime');
const nowTitle = document.getElementById('nowTitle');
const nowArtist = document.getElementById('nowArtist');
const coverImg = document.getElementById('coverImg');
const coverBox = document.getElementById('coverBox');
const visualCanvas = document.getElementById('visualCanvas');
const sleepMin = document.getElementById('sleepMin');
const setSleep = document.getElementById('setSleep');
const cancelSleep = document.getElementById('cancelSleep');
const countdownDisplay = document.getElementById('countdownDisplay');
const clearBtn = document.getElementById('clearBtn');
const savePosBtn = document.getElementById('savePos');
const lastSaved = document.getElementById('lastSaved');
const volumeSlider = document.getElementById('volumeSlider');

// Vari√°veis
let files=[], order=[], current=0;
let isPlaying=false, isShuffle=false, isRepeat=false;
let analyser,audioCtx,dataArray,source;
let bars=[];
let sleepTimeout=null,countdownInterval=null,sleepRemaining=0;

// ----------------------
// HELPERS
// ----------------------
function fmt(s){ if (isNaN(s)||s===null||s===undefined) return '0:00'; return Math.floor(s/60)+':'+String(Math.floor(s%60)).padStart(2,'0'); }
function safePlay(){
  audio.play().then(()=>{ isPlaying=true; playBtn.textContent='‚è∏Ô∏è'; startVisualizer(); }).catch(()=>{ playBtn.textContent='‚ñ∂Ô∏è (clique)'; playBtn.onclick=()=>{ audio.play().then(()=>{ isPlaying=true; playBtn.textContent='‚è∏Ô∏è'; startVisualizer(); playBtn.onclick=null; }); } });
}
function safePause(){ audio.pause(); isPlaying=false; playBtn.textContent='‚ñ∂Ô∏è'; }

// ----------------------
// LOAD TRACK / LIST
// ----------------------
function loadTrackAt(pos){
  if (!files.length) return;
  pos=(pos+order.length)%order.length; current=pos;
  const file=files[order[current]];
  try{ if(audio.src&&audio.src.startsWith('blob:')) URL.revokeObjectURL(audio.src); }catch(e){}
  audio.src=URL.createObjectURL(file);
  nowTitle.textContent=file.name.replace(/\.[^/.]+$/,'');
  nowArtist.textContent='Arquivo local';
  coverImg.style.display='none';
  visualCanvas.style.opacity=1;

  try{ if(window.jsmediatags){ jsmediatags.read(file,{onSuccess:function(tag){ const picture=tag.tags.picture; const t=tag.tags.title||file.name.replace(/\.[^/.]+$/,''); const artist=tag.tags.artist||'Local'; nowTitle.textContent=t; nowArtist.textContent=artist; if(picture&&picture.data){ const base64String=arrayBufferToBase64(picture.data); coverImg.src=`data:${picture.format};base64,${base64String}`; coverImg.style.display='block'; visualCanvas.style.opacity=0.14; const items=listEl.querySelectorAll('.track-item'); items.forEach(node=>{ if(parseInt(node.dataset.index)===order[current]){ const img=node.querySelector('.track-thumb img'); img.src=coverImg.src; img.style.display='block'; } }); }else{ coverImg.style.display='none'; visualCanvas.style.opacity=1; } }, onError:function(){ coverImg.style.display='none'; visualCanvas.style.opacity=1; } }); } }catch(e){ coverImg.style.display='none'; visualCanvas.style.opacity=1; }
  updateActiveInList(); audio.load();
}

// Converte picture para base64
function arrayBufferToBase64(buffer){ let binary=''; const bytes=new Uint8Array(buffer); for(let i=0;i<bytes.byteLength;i++){ binary+=String.fromCharCode(bytes[i]); } return btoa(binary); }

// Render list
function renderList(){ listEl.innerHTML=''; files.forEach((f,i)=>{ const wrap=document.createElement('div'); wrap.className='track-item'; wrap.dataset.index=i; const thumb=document.createElement('div'); thumb.className='track-thumb'; const img=document.createElement('img'); img.alt='thumb'; img.style.display='none'; thumb.appendChild(img); const meta=document.createElement('div'); meta.className='track-meta'; const t=document.createElement('div'); t.className='track-title'; t.textContent=f.name.replace(/\.[^/.]+$/,''); const s=document.createElement('div'); s.className='track-sub'; s.textContent=f.size?(f.size/1024/1024).toFixed(2)+' MB':''; meta.appendChild(t); meta.appendChild(s); wrap.appendChild(thumb); wrap.appendChild(meta); wrap.onclick=()=>{ const idx=order.indexOf(parseInt(wrap.dataset.index)); current=idx>=0?idx:0; loadTrackAt(current); safePlay(); }; listEl.appendChild(wrap); }); updateActiveInList(); setTimeout(tryPopulateThumbnails,300); }

// Atualiza ativo
function updateActiveInList(){ document.querySelectorAll('.track-item').forEach(node=>{ const idx=parseInt(node.dataset.index); const pos=order.indexOf(idx); node.classList.toggle('active',pos===current); }); }

// ----------------------
// PLAYER CONTROLS
// ----------------------
playBtn.addEventListener('click',()=>audio.paused?safePlay():safePause());
prevBtn.addEventListener('click',()=>{ if(audio.currentTime>2){ audio.currentTime=0; }else{ current=(current-1+order.length)%order.length; loadTrackAt(current); safePlay(); } });
nextBtn.addEventListener('click',()=>{ if(isRepeat){ loadTrackAt(current); safePlay(); return; } current=(current+1)%order.length; loadTrackAt(current); safePlay(); });
shuffleBtn.addEventListener('click',()=>{ isShuffle=!isShuffle; shuffleBtn.style.background=isShuffle?'rgba(29,185,84,0.14)':'transparent'; order=isShuffle?files.map((_,i)=>i).sort(()=>Math.random()-0.5):files.map((_,i)=>i); loadTrackAt(current); });
repeatBtn.addEventListener('click',()=>{ isRepeat=!isRepeat; repeatBtn.style.background=isRepeat?'rgba(29,185,84,0.14)':'transparent'; });

audio.addEventListener('ended', () => {
  if (!files.length) return;   // seguran√ßa, sem arquivos nada acontece

  if (isRepeat) {
    // repete a mesma faixa
    loadTrackAt(current);
    play();
    return;
  }

  // avan√ßa para a pr√≥xima faixa
  if (isShuffle) {
    // em shuffle, escolhe pr√≥ximo aleat√≥rio
    current = Math.floor(Math.random() * files.length);
  } else {
    current = (current + 1) % files.length;
  }

  loadTrackAt(current);
  play();
});

// Volume
volumeSlider.addEventListener('input',()=>{ audio.volume=volumeSlider.value; });

// File input
fileInput.addEventListener('change',(e)=>{ files=Array.from(e.target.files).filter(f=>f.type.startsWith('audio/')); order=files.map((_,i)=>i); current=0; renderList(); loadTrackAt(current); safePlay(); });

// Clear
clearBtn.addEventListener('click',()=>{ files=[]; order=[]; current=0; listEl.innerHTML=''; audio.src=''; nowTitle.textContent='Nenhuma faixa'; nowArtist.textContent='Selecione a pasta'; });

// Save/Restore position
savePosBtn.addEventListener('click',()=>{ localStorage.setItem('player_last',JSON.stringify({index:current,name:nowTitle.textContent,pos:audio.currentTime})); updateLastSaved(); });
function updateLastSaved(){ const raw=localStorage.getItem('player_last'); if(!raw){ lastSaved.textContent='‚Äî'; return; } try{ const p=JSON.parse(raw); lastSaved.textContent=p.name+' @ '+fmt(p.pos); }catch(e){ lastSaved.textContent='‚Äî'; } }
updateLastSaved();

// Auto load
window.addEventListener('load',()=>{ const raw=localStorage.getItem('player_last'); if(raw){ try{ const p=JSON.parse(raw); nowTitle.textContent=p.name||'Nenhuma faixa'; nowArtist.textContent='√öltima sess√£o'; audio.currentTime=p.pos||0; }catch(e){} } });

// ----------------------
// SLEEP TIMER
// ----------------------
setSleep.addEventListener('click',()=>{ const m=parseInt(sleepMin.value); if(isNaN(m)||m<=0)return; sleepRemaining=m*60; countdownDisplay.textContent=fmt(sleepRemaining); if(countdownInterval)clearInterval(countdownInterval); countdownInterval=setInterval(()=>{ sleepRemaining--; if(sleepRemaining<=0){ clearInterval(countdownInterval); countdownDisplay.textContent='‚Äî'; safePause(); } else countdownDisplay.textContent=fmt(sleepRemaining); },1000); });
cancelSleep.addEventListener('click',()=>{ if(countdownInterval)clearInterval(countdownInterval); countdownDisplay.textContent='‚Äî'; });

// ----------------------
// VISUALIZER
// ----------------------
function startVisualizer(){
  if(audioCtx) return;
  audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  source=audioCtx.createMediaElementSource(audio);
  analyser=audioCtx.createAnalyser();
  source.connect(analyser); analyser.connect(audioCtx.destination);
  analyser.fftSize=64; const bufferLength=analyser.frequencyBinCount; dataArray=new Uint8Array(bufferLength);
  for(let i=0;i<bufferLength;i++){ const bar=document.createElement('div'); bar.style.width='4px'; bar.style.height='2px'; bar.style.margin='1px'; bar.style.background= 'var(--accent)'; visualCanvas.appendChild(bar); bars.push(bar); }
  function render(){ requestAnimationFrame(render); analyser.getByteFrequencyData(dataArray); for(let i=0;i<bars.length;i++){ bars[i].style.height=(dataArray[i]/255*30+2)+'px'; } } render();
}

// ----------------------
// TRY POPULATE THUMBNAILS
// ----------------------
function tryPopulateThumbnails(){ document.querySelectorAll('.track-item').forEach(node=>{ const img=node.querySelector('img'); if(!img.src){ img.src=''; img.style.display='none'; } }); }
</script>

</body>
</html>
